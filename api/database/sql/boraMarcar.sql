create database boraMarcar;

use boraMarcar;

CREATE TABLE Usuario (
id INT AUTO_INCREMENT PRIMARY KEY UNIQUE,
nome VARCHAR(100)  NOT NULL,
telefone VARCHAR(100) NOT NULL UNIQUE,
email VARCHAR(100) NOT NULL UNIQUE,
senha VARCHAR(100) NOT NULL,
fk_Imagem_id INT NOT NULL,
criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
atualizado_em DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP NOT NULL
);

CREATE TABLE Pessoa (
cpf VARCHAR(20) UNIQUE NOT NULL,
data_nascimento TIMESTAMP NOT NULL,
fk_Usuario_id INT,
PRIMARY KEY (cpf, fk_Usuario_id)
);

CREATE TABLE Estabelecimento (
cnpj VARCHAR(20) UNIQUE NOT NULL,
tipo VARCHAR(100) NOT NULL,
fk_Usuario_id INT,
fk_Endereco_id INT,
PRIMARY KEY (CNPJ, fk_Usuario_id)
);

CREATE TABLE Evento (
id INT AUTO_INCREMENT PRIMARY KEY UNIQUE,
horario TIMESTAMP NOT NULL,
nome VARCHAR(100) NOT NULL,
descricao varchar(100) NOT NULL,
publico BOOLEAN NOT NULL,
fk_Usuario_id INT NOT NULL,
fk_Endereco_id INT NOT NULL,
fk_Imagem_id INT NOT NULL,
criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
atualizado_em DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP NOT NULL
);

CREATE TABLE Imagem (
id INT AUTO_INCREMENT PRIMARY KEY UNIQUE,
arquivo LONGBLOB NOT NULL,
nome VARCHAR (200) NOT NULL,
tipo VARCHAR(50) NOT NULL
);

CREATE TABLE Endereco (
id INT AUTO_INCREMENT PRIMARY KEY UNIQUE,
logradouro VARCHAR(200) NOT NULL,
complemento VARCHAR (200),
cep VARCHAR(15) NOT NULL,
municipio VARCHAR(100) NOT NULL,
estado VARCHAR(100) NOT NULL
);

CREATE TABLE Comparece (
fk_Pessoa_CPF VARCHAR(20),
fk_Usuario_id INT,
fk_Evento_id INT,
PRIMARY KEY (fk_Usuario_id, fk_Evento_id),
criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
atualizado_em DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE Sessao (
id INT AUTO_INCREMENT PRIMARY KEY UNIQUE,
fk_Usuario_id INT,
token VARCHAR(100) NOT NULL,
criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
atualizado_em DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

ALTER TABLE Usuario ADD CONSTRAINT FK_Usuario_1
FOREIGN KEY (fk_Imagem_id)
REFERENCES Imagem (id)
ON DELETE CASCADE;

ALTER TABLE Pessoa ADD CONSTRAINT FK_Pessoa_1
FOREIGN KEY (fk_Usuario_id)
REFERENCES Usuario (id)
ON DELETE CASCADE;

ALTER TABLE Estabelecimento ADD CONSTRAINT FK_Estabelecimento_1
FOREIGN KEY (fk_Usuario_id)
REFERENCES Usuario (id)
ON DELETE CASCADE;

ALTER TABLE Evento ADD CONSTRAINT FK_Evento_1
FOREIGN KEY (fk_Usuario_id)
REFERENCES Usuario (id)
ON DELETE CASCADE;

ALTER TABLE Evento ADD CONSTRAINT FK_Evento_2
FOREIGN KEY (fk_Imagem_id)
REFERENCES Imagem (id)
ON DELETE CASCADE;

ALTER TABLE Comparece ADD CONSTRAINT FK_Comparece_1
FOREIGN KEY (fk_Pessoa_CPF, fk_Usuario_id)
REFERENCES Pessoa (CPF, fk_Usuario_id);

ALTER TABLE Comparece ADD CONSTRAINT FK_Comparece_2
FOREIGN KEY (fk_Evento_id)
REFERENCES Evento (id);

ALTER TABLE Comparece ADD UNIQUE Comparece_Unique
(fk_Pessoa_CPF,fk_Usuario_id, fk_Evento_id);


ALTER TABLE Sessao ADD CONSTRAINT FK_Sessao_1
FOREIGN KEY (fk_Usuario_id)
REFERENCES Usuario (id);

ALTER TABLE Estabelecimento ADD CONSTRAINT FK_Endereco_1
FOREIGN KEY (fk_Endereco_id)
REFERENCES Endereco (id)
ON DELETE CASCADE;

ALTER TABLE Evento ADD CONSTRAINT FK_Endereco_2
FOREIGN KEY (fk_Endereco_id)
REFERENCES Endereco (id)
ON DELETE CASCADE;